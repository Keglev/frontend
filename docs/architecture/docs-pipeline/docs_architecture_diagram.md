# Documentation Pipeline Architecture

## System Overview

```mermaid
graph TD
    subgraph main["MAIN BRANCH (Source of Truth)"]
        direction LR
        subgraph committed["✓ Committed"]
            src["src/"]
            docs["docs/"]
            scripts["scripts/build-arch-docs.sh"]
            configs["package.json<br/>typedoc.json<br/>vitest.config.ts<br/>.github/workflows/<br/>.dockerignore<br/>.gitignore<br/>Dockerfile<br/>README.md"]
        end
        
        subgraph generated["✗ Not Committed (gitignore)"]
            dist["dist/ (Vite build)"]
            coverage["coverage/ (Test coverage)"]
            publicdocs["public-docs/ (Generated docs)"]
            nodemodules["node_modules/"]
        end
        
        subgraph generated2["Generated by npm run docs:all"]
            publicdocs2["public-docs/index.html<br/>public-docs/architecture/*.html<br/>public-docs/typedoc/<br/>public-docs/coverage/<br/>public-docs/templates/*.css"]
        end
    end
    
    main --> deploy["deploy-frontend.yml"]
    main --> docspipe["docs-pipeline.yml"]
    
    deploy --> vercel["VERCEL PRODUCTION<br/>https://stockease-...vercel.app/"]
    docspipe --> ghpages["GITHUB PAGES gh-pages<br/>https://keglev.github.io/stockease-frontend/"]
    
    vercel --> vContent["✓ dist/ production app<br/>✗ .md files<br/>✗ Test files<br/>✗ Documentation source"]
    ghpages --> ghContent["✓ public-docs/index.html<br/>✓ Architecture HTML<br/>✓ TypeDoc API<br/>✓ Coverage reports<br/>✗ Source files<br/>✗ node_modules"]
    
    style main fill:#e1f5ff
    style vercel fill:#c8e6c9
    style ghpages fill:#fff9c4
    style vContent fill:#c8e6c9
    style ghContent fill:#fff9c4
```

---

## File Generation Pipeline

```mermaid
graph TD
    docall["npm run docs:all"]
    
    docall --> clean["npm run docs:clean"]
    docall --> arch["npm run docs:arch"]
    docall --> typedoc["npm run docs:typedoc"]
    docall --> coverage["npm run docs:coverage"]
    docall --> landing["npm run docs:landing"]
    
    clean --> cleanout["Remove public-docs<br/>Create public-docs/<br/>├── architecture/<br/>├── typedoc/<br/>└── coverage/"]
    
    arch --> archconv["Pandoc<br/>Converts markdown → HTML<br/>Uses template<br/>Applies CSS<br/>Adds TOC"]
    archconv --> archout["Output:<br/>public-docs/architecture/"]
    
    typedoc --> typedocconv["TypeDoc<br/>Generates from source code<br/>├── index.html<br/>├── Search<br/>├── API docs<br/>└── Modules"]
    typedocconv --> typedocout["Output:<br/>public-docs/typedoc/"]
    
    coverage --> covconv["Vitest<br/>Generates coverage report<br/>├── index.html<br/>└── Coverage data"]
    covconv --> covout["Output:<br/>public-docs/coverage/"]
    
    landing --> landingconv["Node.js<br/>Converts docs/index.md → index.html<br/>Uses template + CSS<br/>Creates landing page"]
    landingconv --> landingout["Output:<br/>public-docs/index.html"]
    
    cleanout --> final["public-docs/ Final Output<br/>├── index.html<br/>├── architecture/ (all sections)<br/>├── typedoc/ (API docs)<br/>├── coverage/ (test reports)<br/>└── templates/ (CSS)"]
    
    archout --> final
    typedocout --> final
    covout --> final
    landingout --> final
    
    final --> ghpages["Publish to gh-pages<br/>via peaceiris/actions-gh-pages@v3"]
    
    ghpages --> deployed["GitHub Pages<br/>https://keglev.github.io/stockease-frontend/"]
    
    style docall fill:#bbdefb
    style final fill:#c8e6c9
    style deployed fill:#fff9c4
```

---

## Workflow Decision Tree

```mermaid
graph TD
    push["Push to main"]
    
    push --> checkdeploy["deploy-frontend.yml<br/>Always runs<br/>Irrelevant of paths"]
    push --> checkdocs["docs-pipeline.yml<br/>Conditional path-based"]
    
    checkdeploy --> deploy1["1. Test npm test"]
    deploy1 --> deploy2["2. Build npm run build"]
    deploy2 --> deploy3["3. Docker verify"]
    deploy3 --> deploy4["4. Deploy to Vercel"]
    deploy4 --> deployout["Output: dist/ → Vercel<br/>Duration: 3-5 minutes"]
    
    checkdocs --> fileschanged{{"Changed files<br/>include:<br/>docs/**<br/>src/**<br/>*.json config<br/>vitest.config.ts"}}
    
    fileschanged -->|YES| docsbuild["1. Build arch docs<br/>2. Generate TypeDoc<br/>3. Generate coverage<br/>4. Build landing page<br/>5. Publish to gh-pages"]
    fileschanged -->|NO| docsskip["SKIP"]
    
    docsbuild --> docsout["Output: public-docs/ → gh-pages<br/>Duration: 2-4 minutes"]
    
    style push fill:#bbdefb
    style deployout fill:#c8e6c9
    style docsout fill:#fff9c4
    style docsskip fill:#ffccbc
```

---

## Security & Isolation

```mermaid
graph LR
    subgraph prod["Production Pipeline deploy-frontend.yml"]
        p1["Input:<br/>main branch<br/>complete source"]
        p2[".dockerignore<br/>excludes:<br/>docs/<br/>*.md<br/>**/__tests__<br/>.github/<br/>Coverage files"]
        p3["Docker copies:<br/>src/<br/>public/<br/>config files only"]
        p4["Builds:<br/>dist/<br/>production bundle"]
        p5["Result:<br/>Lean image<br/>no docs"]
        p6["Deployed to:<br/>Vercel"]
    end
    
    subgraph doc["Documentation Pipeline docs-pipeline.yml"]
        d1["Input:<br/>main branch<br/>only when relevant<br/>files change"]
        d2["Generates:<br/>public-docs/<br/>temporary"]
        d3["Runs:<br/>npm run docs:all<br/>Pandoc markdown→HTML<br/>TypeDoc source→API docs<br/>Vitest coverage→reports<br/>Landing index.md→HTML"]
        d4["Publishes:<br/>public-docs/→gh-pages<br/>only"]
        d5["Result:<br/>Clean documentation<br/>site"]
        d6["Served at:<br/>GitHub Pages"]
    end
    
    subgraph results["Separation Results"]
        r1["✅ No docs in production"]
        r2["✅ No code in docs"]
        r3["✅ Different deployment"]
        r4["✅ Different builds"]
        r5["✅ Different access"]
    end
    
    p1 --> p2 --> p3 --> p4 --> p5 --> p6
    d1 --> d2 --> d3 --> d4 --> d5 --> d6
    p6 --> results
    d6 --> results
    
    style prod fill:#c8e6c9
    style doc fill:#fff9c4
    style results fill:#e1bee7
```

---

## Caching & Performance

```mermaid
graph TD
    subgraph browser["Client Browser"]
        b1["Landing page:<br/>No cache<br/>checks for updates"]
        b2["Architecture pages:<br/>Browser cache<br/>mostly static"]
        b3["TypeDoc pages:<br/>Browser cache<br/>generated once<br/>per src change"]
        b4["Coverage pages:<br/>Browser cache<br/>generated per<br/>test run"]
        b5["Static assets CSS JS:<br/>Pandoc-generated CSS<br/>Browser cache<br/>Mermaid.js CDN:<br/>CDN cache"]
    end
    
    subgraph github["GitHub Pages"]
        g1["Serves static<br/>HTML directly"]
        g2["Uses HTTP/2"]
        g3["GZIP compression<br/>enabled"]
        g4["CDN caching<br/>Cloudflare"]
        g5["Edge locations<br/>worldwide"]
    end
    
    subgraph vercel["Production Vercel"]
        v1["React app:<br/>Dynamic<br/>Next.js-like behavior"]
        v2["Static files:<br/>Vercel edge cache"]
        v3["API proxying:<br/>Dynamic<br/>to backend"]
        v4["Auto-scaling:<br/>Serverless functions"]
    end
    
    style browser fill:#c8e6c9
    style github fill:#fff9c4
    style vercel fill:#f8bbd0
```

---

## Change Detection Logic

### docs-pipeline.yml triggers when:

| Trigger | Action | Result |
|---------|--------|--------|
| `docs/architecture/*.md` changed | ✅ Rebuild architecture HTML | Docs updated |
| `src/*.ts` or `src/*.tsx` changed | ✅ Regenerate TypeDoc | API docs updated |
| `vitest.config.ts` changed | ✅ Rebuild with new config | Coverage updated |
| `typedoc.json` changed | ✅ Rebuild with new config | API docs updated |
| `package.json` or `package-lock.json` changed | ✅ Rebuild | Dependencies may affect docs |
| Only tests changed `*.test.ts` | ⏭️ SKIPPED | No docs rebuild needed |
| Only linting changed `.eslintrc` | ⏭️ SKIPPED | No docs rebuild needed |
| Only production code `src/main.tsx` | ⏭️ SKIPPED | No docs rebuild needed |
| Only workflows changed | ⏭️ SKIPPED | No docs rebuild needed |

This prevents unnecessary documentation rebuilds when they're not needed.

---

## Link Resolution Logic

Generated HTML uses JavaScript to resolve paths dynamically:

```javascript
function getRootFrom(pathname) {
  // Example paths:
  // /stockease-frontend/index.html
  //   → root = ./
  // /stockease-frontend/architecture/overview.html
  //   → root = ../
  // /stockease-frontend/architecture/api/overview.html
  //   → root = ../../
  
  // Works under any subdomain:
  // https://keglev.github.io/stockease-frontend/ ✅
  // https://custom.com/docs/stockease/ ✅
  // https://docs.stockease.example.com/ ✅
}

CSS Path: ${root} + templates/frontend-docs.css
Home Link: ${root} + index.html
API Link: ${root} + typedoc/index.html
Coverage Link: ${root} + coverage/index.html
```

---

## Summary

This architecture provides:

✅ **Complete Separation**: Docs and production never mix  
✅ **Automated Generation**: All docs built on every relevant change  
✅ **Targeted Triggers**: Only runs when needed  
✅ **Clean Distribution**: Each system gets exactly what it needs  
✅ **Security**: No documentation in production code  
✅ **Performance**: Lean images, efficient pipelines  
✅ **Scalability**: GitHub Pages handles docs, Vercel handles app  
✅ **Maintenance**: Single source of truth (main branch)  

---

Generated: November 12, 2025
