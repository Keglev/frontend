name: Test & Build & Deploy Frontend

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # ============================================================================
  # STAGE 1: Test - Run unit and integration tests on every commit/PR
  # ============================================================================
  test:
    runs-on: ubuntu-latest
    name: Test Suite
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test -- --run --reporter=default

      - name: Generate coverage report
        run: npm run test:coverage || echo "Coverage report generation skipped"
        continue-on-error: true

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            **/__tests__/**/*.test.ts
            **/__tests__/**/*.test.tsx
          check_name: Test Results

  # ============================================================================
  # STAGE 2: Build & Deploy - Only runs on push to master/main (skip on PR)
  # ============================================================================
  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    name: Build & Deploy to Production
    # Only run on push to master/main, not on PRs
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    env:
      FRONTEND_API_BASE_URL: ${{ secrets.FRONTEND_API_BASE_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build production bundle
        run: |
          if [ -n "${{ secrets.FRONTEND_API_BASE_URL }}" ]; then
            echo "Using VITE_API_BASE_URL from secrets"
            export VITE_API_BASE_URL="${{ secrets.FRONTEND_API_BASE_URL }}"
          fi
          npm run build

      - name: Verify dist output (no tests or docs)
        run: |
          echo "Checking dist folder contents..."
          if [ -d "dist" ]; then
            echo "✓ dist/ directory exists"
            ls -la dist/
            
            # Verify no test files in dist
            if find dist -name "*.test.*" -o -name "*spec.*" | grep -q .; then
              echo "✗ ERROR: Test files found in dist/"
              exit 1
            fi
            echo "✓ No test files in dist/"
            
            # Verify no docs in dist
            if [ -d "dist/docs" ]; then
              echo "✗ ERROR: docs/ directory found in dist/"
              exit 1
            fi
            echo "✓ No docs/ directory in dist/"
          else
            echo "✗ ERROR: dist/ directory not found"
            exit 1
          fi

      - name: Build Docker image (verify Dockerfile)
        run: |
          echo "Building Docker image for verification..."
          if [ -n "${{ secrets.FRONTEND_API_BASE_URL }}" ]; then
            docker build \
              --build-arg VITE_API_BASE_URL="${{ secrets.FRONTEND_API_BASE_URL }}" \
              -f Dockerfile \
              -t stockease-frontend-ci:latest .
          else
            docker build \
              -f Dockerfile \
              -t stockease-frontend-ci:latest .
          fi
          echo "✓ Docker image built successfully"

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -euo pipefail
          
          if [ -z "${VERCEL_TOKEN:-}" ]; then
            echo "✗ ERROR: VERCEL_TOKEN not set in repository secrets"
            exit 1
          fi
          
          echo "Deploying to Vercel..."
          flags=()
          
          if [ -n "${FRONTEND_API_BASE_URL:-}" ]; then
            flags+=(--env "VITE_API_BASE_URL=${FRONTEND_API_BASE_URL}")
          fi
          
          npx vercel deploy --prod --token "$VERCEL_TOKEN" --confirm --yes "${flags[@]}" || {
            echo "✗ Deployment failed"
            exit 1
          }
          
          echo "✓ Deployment completed successfully"

      - name: Deployment Summary
        if: success()
        run: |
          echo "✓ Pipeline completed successfully!"
          echo ""
          echo "Summary:"
          echo "- Tests passed ✓"
          echo "- Build successful ✓"
          echo "- Docker image verified ✓"
          echo "- Deployed to production ✓"

      - name: Notify on failure
        if: failure()
        run: |
          echo "✗ Pipeline failed!"
          echo "Please check the logs above for details."
          exit 1

